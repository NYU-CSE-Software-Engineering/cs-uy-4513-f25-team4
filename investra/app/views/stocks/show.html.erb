<h1><%= @stock.name %> (<%= @stock.symbol %>)</h1>

<!-- Real-time Price Section with Live Badge -->
<div class="real-time-price" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; margin: 20px 0; border-radius: 15px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative;">
  <% 
    updated_minutes_ago = ((Time.now - @stock.updated_at) / 60).round
    is_fresh = updated_minutes_ago < 10
    is_stale = updated_minutes_ago > 120 # 2 hours
  %>
  
  <!-- LIVE Badge -->
  <% if is_fresh %>
    <div style="position: absolute; top: 20px; right: 20px; background: #28a745; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; animation: pulse 2s infinite;">
      <span style="display: inline-block; width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 5px; animation: blink 1s infinite;"></span>
      LIVE
    </div>
  <% end %>
  
  <h2 style="color: white; margin-top: 0; display: flex; align-items: center; gap: 10px;">
    üìä Real-time Price Information
  </h2>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
    <div>
      <p style="margin: 0; opacity: 0.9; font-size: 0.9em;">Current Price</p>
      <p id="current-price" style="margin: 5px 0 0 0; font-size: 2.5em; font-weight: bold;">
        $<%= number_with_precision(@stock.price, precision: 2) %>
      </p>
      <!-- For test compatibility -->
      <span style="position: absolute; left: -9999px;">Current Price: $<%= number_with_precision(@stock.price, precision: 2) %></span>
    </div>
    
    <div>
      <p style="margin: 0; opacity: 0.9; font-size: 0.9em;">24h Change</p>
      <% price_change = @stock.price_change %>
      <% if price_change %>
        <p style="margin: 5px 0 0 0; font-size: 1.8em; font-weight: bold;">
          <span style="color: <%= price_change[:direction] == 'positive' ? '#d4edda' : '#f8d7da' %>;">
            <%= price_change[:direction] == 'positive' ? '‚ñ≤' : '‚ñº' %> 
            <%= price_change[:direction] == 'positive' ? '+' : '-' %>$<%= number_with_precision(price_change[:amount].abs, precision: 2) %> 
            (<%= price_change[:direction] == 'positive' ? '+' : '' %><%= price_change[:percentage] %>%)
          </span>
        </p>
      <% else %>
        <p style="margin: 5px 0 0 0; font-size: 1.5em;">--</p>
      <% end %>
    </div>
  </div>
  
  <!-- Last Updated & Refresh Button -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.3);">
    <div>
      <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Last Updated: <span id="last-updated-time"><%= @stock.last_updated_human %></span></p>
      <p style="margin: 5px 0 0 0; font-size: 0.8em; opacity: 0.7;">
        <span id="auto-refresh-timer">Data refreshes automatically</span>
      </p>
    </div>
    
    <button id="refresh-data-btn" onclick="refreshStockData()" style="background: <%= is_stale ? '#ffc107' : 'white' %>; color: <%= is_stale ? 'white' : '#667eea' %>; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1em; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; <%= is_stale ? 'animation: pulse 2s infinite;' : '' %>">
      <span id="refresh-btn-text">üîÑ <%= is_stale ? 'Refresh Now' : 'Refresh Data' %></span>
    </button>
  </div>
  
  <!-- Staleness Warning -->
  <% if is_stale %>
    <div class="warning alert-warning" style="background: rgba(255, 193, 7, 0.2); border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin-top: 20px;">
      <p style="margin: 0; font-weight: bold; color: #ffc107;">‚ö†Ô∏è Price data may be outdated</p>
      <p style="margin: 5px 0 0 0; font-size: 0.9em;">
        Last updated: 
        <% hours = (updated_minutes_ago / 60.0).floor %>
        <% if hours >= 1 %>
          <%= hours %> hour<%= hours > 1 ? 's' : '' %> ago
        <% else %>
          <%= updated_minutes_ago %> min ago
        <% end %>. 
        Click "Refresh Now" for the latest price.
      </p>
    </div>
  <% end %>
</div>

<style>
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

#refresh-data-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 7px 20px rgba(0,0,0,0.3);
}

#refresh-data-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

<script>
function refreshStockData() {
  const stockId = <%= @stock.id %>;
  const refreshBtn = document.getElementById('refresh-data-btn');
  const refreshBtnText = document.getElementById('refresh-btn-text');
  const priceElement = document.getElementById('current-price');
  const lastUpdatedElement = document.getElementById('last-updated-time');
  
  // Disable button and show loading
  refreshBtn.disabled = true;
  refreshBtnText.textContent = '‚è≥ Refreshing...';
  
  fetch(`/stocks/${stockId}/refresh`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update price
      priceElement.textContent = `$${data.stock.price.toFixed(2)}`;
      
      // Update last updated time
      lastUpdatedElement.textContent = 'just now';
      
      // Show success message
      refreshBtnText.textContent = '‚úÖ Refreshed!';
      
      // Reload page after 1 second to show updated chart/stats
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      refreshBtnText.textContent = '‚ùå Failed';
      setTimeout(() => {
        refreshBtnText.textContent = 'üîÑ Refresh Data';
        refreshBtn.disabled = false;
      }, 2000);
    }
  })
  .catch(error => {
    console.error('Refresh error:', error);
    refreshBtnText.textContent = '‚ùå Error';
    setTimeout(() => {
      refreshBtnText.textContent = 'üîÑ Refresh Data';
      refreshBtn.disabled = false;
    }, 2000);
  });
}

// Auto-refresh countdown (optional)
let secondsUntilRefresh = 300; // 5 minutes
function updateAutoRefreshTimer() {
  const timerElement = document.getElementById('auto-refresh-timer');
  if (secondsUntilRefresh > 0) {
    const minutes = Math.floor(secondsUntilRefresh / 60);
    const seconds = secondsUntilRefresh % 60;
    timerElement.textContent = `Auto-refresh in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    secondsUntilRefresh--;
  } else {
    // Auto-refresh when timer hits 0
    refreshStockData();
    secondsUntilRefresh = 300; // Reset timer
  }
}

// Update timer every second
setInterval(updateAutoRefreshTimer, 1000);
</script>

<div class="stock-info">
  <h2>Company Information</h2>
  <p><strong>Symbol:</strong> <%= @stock.symbol %></p>
  <p><strong>Available Quantity:</strong> <%= @stock.available_quantity %></p>
  
  <% if @stock.sector.present? %>
    <p><strong>Sector:</strong> <%= @stock.sector %></p>
  <% end %>
  
  <% if @stock.market_cap.present? %>
    <p><strong>Market Cap:</strong> $<%= number_with_delimiter(@stock.market_cap) %></p>
  <% end %>
  
  <% if @stock.description.present? %>
    <p><strong>Description:</strong> <%= @stock.description %></p>
  <% end %>
</div>

<!-- AI Price Prediction Section -->
<div id="ai-prediction-container" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 25px; margin: 20px 0; border-radius: 10px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
  <h2 style="color: white; margin-top: 0;">ü§ñ AI Price Prediction</h2>
  <p style="font-size: 0.9em; opacity: 0.9; margin: 5px 0 20px 0;">Logistic Regression Model</p>
  
  <!-- Initial State: Generate Prediction Button -->
  <div id="prediction-initial" style="text-align: center; padding: 30px 0;">
    <p style="font-size: 1.1em; margin-bottom: 20px;">Click below to generate AI-powered price prediction using machine learning</p>
    <button id="generate-prediction-btn" 
            data-stock-id="<%= @stock.id %>"
            style="background: white; color: #11998e; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.3s ease;">
      üöÄ Generate Prediction
    </button>
  </div>
  
  <!-- Loading State -->
  <div id="prediction-loading" style="display: none; text-align: center; padding: 30px 0;">
    <div style="margin-bottom: 20px;">
      <div class="spinner" style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
    </div>
    <p style="font-size: 1.1em; margin: 0;">üß† Running Logistic Regression Model...</p>
    <p style="font-size: 0.9em; opacity: 0.9; margin: 10px 0 0 0;">Analyzing historical price patterns</p>
  </div>
  
  <!-- Result State -->
  <div id="prediction-result" style="display: none;">
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
      <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
        <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Predicted Price</p>
        <p class="prediction-price" id="predicted-price" style="margin: 5px 0 0 0; font-size: 1.8em; font-weight: bold;">
          --
        </p>
        <p class="prediction-trend" id="prediction-trend" style="margin: 5px 0 0 0; font-size: 0.9em;">
          --
        </p>
      </div>
      
      <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
        <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Confidence</p>
        <p id="confidence-value" style="margin: 5px 0 0 0; font-size: 1.8em; font-weight: bold;">
          --
        </p>
        <p id="probability-value" style="margin: 5px 0 0 0; font-size: 0.9em;">
          --
        </p>
      </div>
    </div>
    
    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">
      <p id="data-points-info" style="margin: 0; font-size: 0.9em;">
        --
      </p>
    </div>
    
    <div style="text-align: center; margin-top: 15px;">
      <button id="regenerate-prediction-btn" 
              style="background: rgba(255,255,255,0.3); color: white; border: 1px solid white; padding: 10px 25px; border-radius: 25px; font-size: 0.9em; cursor: pointer; transition: all 0.3s ease;">
        üîÑ Regenerate Prediction
      </button>
    </div>
  </div>
  
  <!-- Error State -->
  <div id="prediction-error" style="display: none; text-align: center; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 8px;">
    <p style="margin: 0; font-size: 1.1em;">‚ö†Ô∏è <strong id="error-message">Insufficient data for prediction</strong></p>
    <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.9;">At least 7 days of historical price data is required</p>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#generate-prediction-btn:hover,
#regenerate-prediction-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 7px 20px rgba(0,0,0,0.3);
}
</style>

<script>
function initializePrediction() {
  const generateBtn = document.getElementById('generate-prediction-btn');
  const regenerateBtn = document.getElementById('regenerate-prediction-btn');
  
  console.log('Initializing prediction buttons...', generateBtn, regenerateBtn);
  
  if (generateBtn) {
    // Remove any existing listeners
    const newGenerateBtn = generateBtn.cloneNode(true);
    generateBtn.parentNode.replaceChild(newGenerateBtn, generateBtn);
    
    newGenerateBtn.addEventListener('click', function() {
      console.log('Generate button clicked!');
      generatePrediction();
    });
  }
  
  if (regenerateBtn) {
    regenerateBtn.addEventListener('click', function() {
      console.log('Regenerate button clicked!');
      generatePrediction();
    });
  }
  
  function generatePrediction() {
    const btn = document.getElementById('generate-prediction-btn');
    const stockId = btn ? btn.dataset.stockId : null;
    
    console.log('Generating prediction for stock:', stockId);
    
    if (!stockId) {
      console.error('Stock ID not found!');
      return;
    }
    
    // Show loading state
    document.getElementById('prediction-initial').style.display = 'none';
    document.getElementById('prediction-result').style.display = 'none';
    document.getElementById('prediction-error').style.display = 'none';
    document.getElementById('prediction-loading').style.display = 'block';
    
    // Make AJAX request
    fetch(`/stocks/${stockId}/predict`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(response => {
      console.log('‚úÖ Response received:', response.status, response.statusText);
      if (!response.ok) {
        console.error('‚ùå Response not OK:', response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log('üìä Full prediction data:', JSON.stringify(data, null, 2));
      console.log('‚úì data.success =', data.success);
      console.log('‚úì typeof data.success =', typeof data.success);
      
      document.getElementById('prediction-loading').style.display = 'none';
      
      if (data.success === true) {
        console.log('‚úÖ Success branch - displaying results');
        // Display prediction results
        const prediction = data.prediction;
        console.log('üìà Prediction object:', prediction);
        
        document.getElementById('predicted-price').textContent = '$' + prediction.predicted_price.toFixed(2);
        
        const trendElement = document.getElementById('prediction-trend');
        if (prediction.trend === 'upward') {
          trendElement.innerHTML = 'üìà Upward Trend';
          trendElement.className = 'prediction-trend upward';
        } else {
          trendElement.innerHTML = 'üìâ Downward Trend';
          trendElement.className = 'prediction-trend downward';
        }
        
        document.getElementById('confidence-value').textContent = prediction.confidence.toFixed(2) + '%';
        document.getElementById('probability-value').textContent = 'Probability Up: ' + prediction.probability_up.toFixed(2) + '%';
        document.getElementById('data-points-info').innerHTML = 'üìä Based on <strong>' + prediction.data_points + ' data points</strong> of historical price analysis';
        
        document.getElementById('prediction-result').style.display = 'block';
        console.log('‚úÖ Result displayed successfully');
      } else {
        console.log('‚ö†Ô∏è Error branch - data.success is false or missing');
        console.log('Error message:', data.message);
        // Show error
        document.getElementById('error-message').textContent = data.message || 'Insufficient data for prediction';
        document.getElementById('prediction-error').style.display = 'block';
      }
    })
    .catch(error => {
      console.error('‚ùå Catch block - Network or parsing error:', error);
      console.error('Error details:', error.message, error.stack);
      document.getElementById('prediction-loading').style.display = 'none';
      document.getElementById('error-message').textContent = 'An error occurred while generating prediction';
      document.getElementById('prediction-error').style.display = 'block';
    });
  }
}

// Support both Turbo and regular page loads
document.addEventListener('turbo:load', initializePrediction);
document.addEventListener('DOMContentLoaded', initializePrediction);

// Also run immediately in case page is already loaded
if (document.readyState === 'complete' || document.readyState === 'interactive') {
  setTimeout(initializePrediction, 100);
}
</script>

<!-- Price Trend Graph -->
<% if @chart_data && (@chart_data[:week][:prices].any? || @chart_data[:month][:prices].any? || @chart_data[:year][:prices].any?) %>
  <div class="price-trend-graph" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; margin: 20px 0; border-radius: 10px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
    <h2 style="color: white; margin-top: 0;">üìà Price Trend Graph</h2>
    <p style="opacity: 0.9; margin-bottom: 20px;">Analyze price movements across different timeframes</p>
    
    <!-- Timeframe Buttons -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
      <button class="timeframe-btn" data-timeframe="7" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
        üìÖ Week
      </button>
      <button class="timeframe-btn active" data-timeframe="30" style="background: rgba(255,255,255,0.9); color: #667eea; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
        üìÜ Month
      </button>
      <button class="timeframe-btn" data-timeframe="365" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
        üóìÔ∏è Year
      </button>
    </div>
    
    <!-- Chart Canvas -->
    <div style="background: white; padding: 20px; border-radius: 8px; position: relative; height: 400px;">
      <canvas id="price-trend-chart" 
              data-prices="<%= @chart_data[:month][:prices].to_json %>"
              data-dates="<%= @chart_data[:month][:labels].to_json %>"
              data-week-prices="<%= @chart_data[:week][:prices].to_json %>"
              data-week-dates="<%= @chart_data[:week][:labels].to_json %>"
              data-month-prices="<%= @chart_data[:month][:prices].to_json %>"
              data-month-dates="<%= @chart_data[:month][:labels].to_json %>"
              data-year-prices="<%= @chart_data[:year][:prices].to_json %>"
              data-year-dates="<%= @chart_data[:year][:labels].to_json %>"
              style="max-height: 360px;"></canvas>
    </div>
  </div>
<% else %>
  <div style="background: #f8d7da; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #dc3545; color: #721c24;">
    <p style="margin: 0;"><strong>üìä No price data available for chart</strong></p>
    <p style="margin: 10px 0 0 0;">Price trend graph will be available once sufficient historical data is collected.</p>
  </div>
<% end %>

<!-- Historical Price Section -->
<% if @price_statistics[:high].present? %>
  <div class="historical-prices" style="background: #fff3cd; padding: 20px; margin: 20px 0; border-left: 4px solid #ffc107;">
    <h2 style="color: #856404; margin-top: 0;">30-Day Price Range</h2>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
      <div style="background: white; padding: 15px; border-radius: 5px;">
        <p style="margin: 0; color: #666;">High</p>
        <p style="margin: 5px 0 0 0; font-size: 1.3em; font-weight: bold; color: #28a745;">$<%= number_with_precision(@price_statistics[:high], precision: 2) %></p>
      </div>
      <div style="background: white; padding: 15px; border-radius: 5px;">
        <p style="margin: 0; color: #666;">Low</p>
        <p style="margin: 5px 0 0 0; font-size: 1.3em; font-weight: bold; color: #dc3545;">$<%= number_with_precision(@price_statistics[:low], precision: 2) %></p>
      </div>
      <div style="background: white; padding: 15px; border-radius: 5px;">
        <p style="margin: 0; color: #666;">Average</p>
        <p style="margin: 5px 0 0 0; font-size: 1.3em; font-weight: bold; color: #007bff;">$<%= number_with_precision(@price_statistics[:average], precision: 2) %></p>
      </div>
    </div>
  </div>
<% end %>

<% if @price_history.any? %>
  <div class="price-history-section" style="margin: 20px 0;" id="price-history">
    <h2 style="color: #333;">üìÖ Detailed Price History</h2>
    <p style="color: #666; margin-bottom: 15px;"><%= link_to 'Price History', '#price-history-table' %> - View daily closing prices for the last 30 days</p>
    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
      <table class="price-history" id="price-history-table" style="width: 100%; border-collapse: collapse;">
        <thead style="background: #f8f9fa; position: sticky; top: 0;">
          <tr>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Date</th>
            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Price</th>
          </tr>
        </thead>
        <tbody>
          <% @price_history.each_with_index do |point, index| %>
            <tr style="<%= 'background: #f8f9fa;' if index.even? %>">
              <td style="padding: 10px; border-bottom: 1px solid #eee;"><%= point.recorded_at.strftime("%Y-%m-%d") %></td>
              <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee; font-weight: 500;">$<%= number_with_precision(point.price, precision: 2) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div style="background: #f8d7da; padding: 15px; margin: 20px 0; border-left: 4px solid #dc3545; color: #721c24;">
    <p style="margin: 0;"><strong>‚ö†Ô∏è No Historical Data Available</strong></p>
    <p style="margin: 5px 0 0 0;">Historical price data is not available for this stock yet.</p>
  </div>
<% end %>

<!-- Recent News Section -->
<% if @recent_news.any? %>
  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; margin: 30px 0; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);">
    <h2 style="color: white; margin: 0 0 30px 0; font-size: 2em; display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 1.2em;">üì∞</span> Recent Market News
    </h2>
    
    <div style="display: grid; gap: 20px;">
      <% @recent_news.each_with_index do |news, index| %>
        <div class="news-card" style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); transition: all 0.3s ease; position: relative; overflow: hidden;">
          <!-- Animated accent bar -->
          <div style="position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);"></div>
          
          <div style="margin-left: 15px;">
            <!-- News Badge & Metadata -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
              <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <% if news.source.present? %>
                  <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                    <%= news.source %>
                  </span>
                <% end %>
                <% if news.published_at.present? %>
                  <span style="color: #6c757d; font-size: 0.9em; display: flex; align-items: center; gap: 5px;">
                    <span>üïê</span> <%= time_ago_in_words(news.published_at) %> ago
                  </span>
                <% end %>
              </div>
              
              <span style="background: #f0f0f0; color: #667eea; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: 500;">
                #<%= index + 1 %>
              </span>
            </div>
            
            <!-- News Title -->
            <h3 style="color: #2d3748; margin: 0 0 15px 0; font-size: 1.4em; line-height: 1.4; font-weight: 700;">
              <%= news.title %>
            </h3>
            
            <!-- News Content -->
            <% if news.content.present? %>
              <p style="color: #4a5568; line-height: 1.8; margin: 0 0 20px 0; font-size: 1em;">
                <%= news.content %>
              </p>
            <% end %>
            
            <!-- Read Full Article Button -->
            <% if news.url.present? %>
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 2px solid #f0f0f0;">
                <%= link_to news.url, target: '_blank', rel: 'noopener noreferrer', style: 'display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);' do %>
                  <span>üìñ Read Full Article</span>
                  <span style="font-size: 1.2em;">‚Üí</span>
                <% end %>
                
                <div style="display: flex; gap: 10px;">
                  <button style="background: #f0f0f0; border: none; padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease;" onclick="shareArticle('<%= news.title.gsub("'", "\\'") %>', '<%= news.url %>')">
                    <span style="font-size: 1.1em;">üì§</span>
                  </button>
                  <button style="background: #f0f0f0; border: none; padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease;" onclick="bookmarkArticle('<%= news.title.gsub("'", "\\'") %>')">
                    <span style="font-size: 1.1em;">üîñ</span>
                  </button>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  
  <style>
    .news-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
    }
    
    .news-card a:hover {
      transform: translateX(5px);
      box-shadow: 0 6px 15px rgba(102, 126, 234, 0.5) !important;
    }
    
    .news-card button:hover {
      background: #e0e0e0 !important;
      transform: scale(1.1);
    }
  </style>
  
  <script>
    function shareArticle(title, url) {
      if (navigator.share) {
        navigator.share({
          title: title,
          url: url
        }).catch(err => console.log('Share cancelled'));
      } else {
        navigator.clipboard.writeText(url);
        alert('Link copied to clipboard!');
      }
    }
    
    function bookmarkArticle(title) {
      alert('Bookmarked: ' + title);
      // In a real app, this would save to a database
    }
  </script>
<% else %>
  <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); padding: 30px; margin: 20px 0; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
    <div style="font-size: 3em; margin-bottom: 15px;">üì≠</div>
    <h3 style="color: #2d3748; margin: 0 0 10px 0;">No Recent News Available</h3>
    <p style="color: #4a5568; margin: 0; font-size: 1.1em;">We'll update you as soon as news about <%= @stock.name %> becomes available.</p>
  </div>
<% end %>

<div>
  <%= link_to 'Back to Stocks', stocks_path %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('price-trend-chart');
  if (!canvas) return;
  
  let chart = null;
  
  // Initialize chart with default data (week)
  function initChart(labels, prices) {
    const ctx = canvas.getContext('2d');
    
    if (chart) {
      chart.destroy();
    }
    
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Price ($)',
          data: prices,
          borderColor: 'rgb(102, 126, 234)',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: 'rgb(102, 126, 234)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: {
              size: 14
            },
            bodyFont: {
              size: 13
            },
            callbacks: {
              label: function(context) {
                return ' $' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            ticks: {
              callback: function(value) {
                return '$' + value.toFixed(2);
              },
              font: {
                size: 12
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              font: {
                size: 11
              }
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  // Load initial chart (default: month)
  const monthPrices = JSON.parse(canvas.dataset.monthPrices || '[]');
  const monthDates = JSON.parse(canvas.dataset.monthDates || '[]');
  if (monthPrices.length > 0) {
    initChart(monthDates, monthPrices);
  }
  
  // Handle timeframe button clicks
  document.querySelectorAll('.timeframe-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const timeframe = this.dataset.timeframe;
      
      // Update button styles
      document.querySelectorAll('.timeframe-btn').forEach(b => {
        b.classList.remove('active');
        b.style.background = 'rgba(255,255,255,0.3)';
        b.style.color = 'white';
        b.style.border = '1px solid white';
      });
      this.classList.add('active');
      this.style.background = 'rgba(255,255,255,0.9)';
      this.style.color = '#667eea';
      this.style.border = 'none';
      
      // Load data for selected timeframe
      let prices, dates;
      if (timeframe === '7') {
        prices = JSON.parse(canvas.dataset.weekPrices || '[]');
        dates = JSON.parse(canvas.dataset.weekDates || '[]');
      } else if (timeframe === '30') {
        prices = JSON.parse(canvas.dataset.monthPrices || '[]');
        dates = JSON.parse(canvas.dataset.monthDates || '[]');
      } else if (timeframe === '365') {
        prices = JSON.parse(canvas.dataset.yearPrices || '[]');
        dates = JSON.parse(canvas.dataset.yearDates || '[]');
      }
      
      if (prices.length > 0) {
        initChart(dates, prices);
      }
    });
  });
});
</script>

