<h1><%= @stock.name %> (<%= @stock.symbol %>)</h1>

<!-- Real-time Price Section -->
<div class="real-time-price" style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-left: 4px solid #007bff;">
  <h2 style="color: #007bff; margin-top: 0;">ğŸ“Š Real-time Price Information</h2>
  <p><strong>Current Price:</strong> <span style="font-size: 1.5em; color: #28a745;">$<%= number_with_precision(@stock.price, precision: 2) %></span></p>
  <p><strong>Last Updated:</strong> <%= @stock.last_updated_human %></p>
  <% price_change = @stock.price_change %>
  <% if price_change %>
    <p><strong>24h Change:</strong> 
      <span style="color: <%= price_change[:direction] == 'positive' ? '#28a745' : '#dc3545' %>; font-weight: bold;">
        <%= price_change[:direction] == 'positive' ? 'â–²' : 'â–¼' %> 
        <%= price_change[:direction] == 'positive' ? '+' : '-' %>$<%= number_with_precision(price_change[:amount].abs, precision: 2) %> 
        (<%= price_change[:direction] == 'positive' ? '+' : '' %><%= price_change[:percentage] %>%)
      </span>
    </p>
  <% end %>
</div>

<div class="stock-info">
  <h2>Company Information</h2>
  <p><strong>Symbol:</strong> <%= @stock.symbol %></p>
  <p><strong>Available Quantity:</strong> <%= @stock.available_quantity %></p>
  
  <% if @stock.sector.present? %>
    <p><strong>Sector:</strong> <%= @stock.sector %></p>
  <% end %>
  
  <% if @stock.market_cap.present? %>
    <p><strong>Market Cap:</strong> $<%= number_with_delimiter(@stock.market_cap) %></p>
  <% end %>
  
  <% if @stock.description.present? %>
    <p><strong>Description:</strong> <%= @stock.description %></p>
  <% end %>
</div>

<!-- Price Trend Graph -->
<% if @chart_data && (@chart_data[:week][:prices].any? || @chart_data[:month][:prices].any? || @chart_data[:year][:prices].any?) %>
  <div class="price-trend-graph" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; margin: 20px 0; border-radius: 10px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
    <h2 style="color: white; margin-top: 0;">ğŸ“ˆ Price Trend Graph</h2>
    <p style="opacity: 0.9; margin-bottom: 20px;">Analyze price movements across different timeframes</p>
    
    <!-- Timeframe Buttons -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
      <button class="timeframe-btn active" data-timeframe="7" style="background: rgba(255,255,255,0.9); color: #667eea; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
        ğŸ“… Week
      </button>
      <button class="timeframe-btn" data-timeframe="30" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
        ğŸ“† Month
      </button>
      <button class="timeframe-btn" data-timeframe="365" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
        ğŸ—“ï¸ Year
      </button>
    </div>
    
    <!-- Chart Canvas -->
    <div style="background: white; padding: 20px; border-radius: 8px; position: relative; height: 400px;">
      <canvas id="price-trend-chart" 
              data-prices="<%= @chart_data[:week][:prices].to_json %>"
              data-dates="<%= @chart_data[:week][:labels].to_json %>"
              data-week-prices="<%= @chart_data[:week][:prices].to_json %>"
              data-week-dates="<%= @chart_data[:week][:labels].to_json %>"
              data-month-prices="<%= @chart_data[:month][:prices].to_json %>"
              data-month-dates="<%= @chart_data[:month][:labels].to_json %>"
              data-year-prices="<%= @chart_data[:year][:prices].to_json %>"
              data-year-dates="<%= @chart_data[:year][:labels].to_json %>"
              style="max-height: 360px;"></canvas>
    </div>
  </div>
<% else %>
  <div style="background: #f8d7da; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #dc3545; color: #721c24;">
    <p style="margin: 0;"><strong>ğŸ“Š No price data available for chart</strong></p>
    <p style="margin: 10px 0 0 0;">Price trend graph will be available once sufficient historical data is collected.</p>
  </div>
<% end %>

<!-- Historical Price Section -->
<% if @price_statistics[:high].present? %>
  <div class="historical-prices" style="background: #fff3cd; padding: 20px; margin: 20px 0; border-left: 4px solid #ffc107;">
    <h2 style="color: #856404; margin-top: 0;">30-Day Price Range</h2>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
      <div style="background: white; padding: 15px; border-radius: 5px;">
        <p style="margin: 0; color: #666;">High</p>
        <p style="margin: 5px 0 0 0; font-size: 1.3em; font-weight: bold; color: #28a745;">$<%= number_with_precision(@price_statistics[:high], precision: 2) %></p>
      </div>
      <div style="background: white; padding: 15px; border-radius: 5px;">
        <p style="margin: 0; color: #666;">Low</p>
        <p style="margin: 5px 0 0 0; font-size: 1.3em; font-weight: bold; color: #dc3545;">$<%= number_with_precision(@price_statistics[:low], precision: 2) %></p>
      </div>
      <div style="background: white; padding: 15px; border-radius: 5px;">
        <p style="margin: 0; color: #666;">Average</p>
        <p style="margin: 5px 0 0 0; font-size: 1.3em; font-weight: bold; color: #007bff;">$<%= number_with_precision(@price_statistics[:average], precision: 2) %></p>
      </div>
    </div>
  </div>
<% end %>

<% if @price_history.any? %>
  <div class="price-history-section" style="margin: 20px 0;" id="price-history">
    <h2 style="color: #333;">ğŸ“… Detailed Price History</h2>
    <p style="color: #666; margin-bottom: 15px;"><%= link_to 'Price History', '#price-history-table' %> - View daily closing prices for the last 30 days</p>
    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
      <table class="price-history" id="price-history-table" style="width: 100%; border-collapse: collapse;">
        <thead style="background: #f8f9fa; position: sticky; top: 0;">
          <tr>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Date</th>
            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Price</th>
          </tr>
        </thead>
        <tbody>
          <% @price_history.each_with_index do |point, index| %>
            <tr style="<%= 'background: #f8f9fa;' if index.even? %>">
              <td style="padding: 10px; border-bottom: 1px solid #eee;"><%= point.recorded_at.strftime("%Y-%m-%d") %></td>
              <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee; font-weight: 500;">$<%= number_with_precision(point.price, precision: 2) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div style="background: #f8d7da; padding: 15px; margin: 20px 0; border-left: 4px solid #dc3545; color: #721c24;">
    <p style="margin: 0;"><strong>âš ï¸ No Historical Data Available</strong></p>
    <p style="margin: 5px 0 0 0;">Historical price data is not available for this stock yet.</p>
  </div>
<% end %>

<% if @recent_news.any? %>
  <div class="recent-news">
    <h2>Recent Market News</h2>
    <% @recent_news.each do |news| %>
      <div class="news-item">
        <h3><%= news.title %></h3>
        <% if news.source.present? %>
          <p><strong>Source:</strong> <%= news.source %></p>
        <% end %>
        <% if news.published_at.present? %>
          <p><strong>Published:</strong> <%= news.published_at.strftime("%B %d, %Y at %I:%M %p") %></p>
        <% end %>
        <% if news.content.present? %>
          <p><%= news.content %></p>
        <% end %>
        <% if news.url.present? %>
          <p><%= link_to 'Read full article', news.url, target: '_blank' %></p>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <p>No recent news available for this stock.</p>
<% end %>

<div>
  <%= link_to 'Back to Stocks', stocks_path %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('price-trend-chart');
  if (!canvas) return;
  
  let chart = null;
  
  // Initialize chart with default data (week)
  function initChart(labels, prices) {
    const ctx = canvas.getContext('2d');
    
    if (chart) {
      chart.destroy();
    }
    
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Price ($)',
          data: prices,
          borderColor: 'rgb(102, 126, 234)',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: 'rgb(102, 126, 234)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: {
              size: 14
            },
            bodyFont: {
              size: 13
            },
            callbacks: {
              label: function(context) {
                return ' $' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            ticks: {
              callback: function(value) {
                return '$' + value.toFixed(2);
              },
              font: {
                size: 12
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              font: {
                size: 11
              }
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  // Load initial chart
  const weekPrices = JSON.parse(canvas.dataset.weekPrices || '[]');
  const weekDates = JSON.parse(canvas.dataset.weekDates || '[]');
  if (weekPrices.length > 0) {
    initChart(weekDates, weekPrices);
  }
  
  // Handle timeframe button clicks
  document.querySelectorAll('.timeframe-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const timeframe = this.dataset.timeframe;
      
      // Update button styles
      document.querySelectorAll('.timeframe-btn').forEach(b => {
        b.classList.remove('active');
        b.style.background = 'rgba(255,255,255,0.3)';
        b.style.color = 'white';
        b.style.border = '1px solid white';
      });
      this.classList.add('active');
      this.style.background = 'rgba(255,255,255,0.9)';
      this.style.color = '#667eea';
      this.style.border = 'none';
      
      // Load data for selected timeframe
      let prices, dates;
      if (timeframe === '7') {
        prices = JSON.parse(canvas.dataset.weekPrices || '[]');
        dates = JSON.parse(canvas.dataset.weekDates || '[]');
      } else if (timeframe === '30') {
        prices = JSON.parse(canvas.dataset.monthPrices || '[]');
        dates = JSON.parse(canvas.dataset.monthDates || '[]');
      } else if (timeframe === '365') {
        prices = JSON.parse(canvas.dataset.yearPrices || '[]');
        dates = JSON.parse(canvas.dataset.yearDates || '[]');
      }
      
      if (prices.length > 0) {
        initChart(dates, prices);
      }
    });
  });
});
</script>

