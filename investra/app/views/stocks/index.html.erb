<div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 28px; margin: -20px -20px 20px -20px; color: white; border-bottom: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 40px rgba(0,0,0,0.25);">
  <h1 style="margin: 0 0 8px 0; color: white;">ðŸ“Š Markets</h1>
  <p style="margin: 0; opacity: 0.9;">Track live quotes, search tickers, and trade instantly.</p>
</div>

<% if current_user %>
  <div id="balance" style="background: #0ea5e9; color: white; padding: 14px 16px; margin: 16px 0 10px 0; border-radius: 12px; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 10px 30px rgba(14,165,233,0.35);">
    <span style="font-weight: 700;">ðŸ’° Balance</span>
    <span style="font-weight: 700;">$<%= number_with_precision(current_user.balance, precision: 2) %></span>
  </div>
<% end %>

<% if flash[:notice] %>
  <div class="notice"><%= flash[:notice] %></div>
<% end %>

<% if flash[:alert] %>
  <div class="alert"><%= flash[:alert] %></div>
<% end %>

<% if defined?(@lookup_error) && @lookup_error.present? %>
  <div class="alert alert-warning"><%= @lookup_error %></div>
<% end %>

<style>
  .stock-list { margin-top: 10px; }
  .stock-list table { width: 100%; border-collapse: collapse; }
  .stock-list thead th { padding: 12px 10px; text-align: left; color: #94a3b8; font-size: 13px; font-weight: 700; border-bottom: 1px solid rgba(148,163,184,0.2); }
  .stock-list tbody tr { background: #0f172a; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; box-shadow: 0 14px 30px rgba(0,0,0,0.2); }
  .stock-list tbody tr + tr { margin-top: 8px; }
  .stock-list tbody tr td { padding: 12px 14px; text-align: left; vertical-align: middle; color: #e2e8f0; border-top: 1px solid rgba(255,255,255,0.04); }
  .stock-list tbody tr td:first-child { border-left: 0; }
  .stock-list tbody tr td:last-child { border-right: 0; }

  .buy-btn {
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #4f46e5, #06b6d4);
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(79,70,229,0.35);
  }
  .buy-btn:hover { transform: translateY(-1px); }

  #search-form { display: flex; gap: 8px; align-items: center; margin: 12px 0 4px 0; }
  #search-form input[type='text'] { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.4); background: #0b1220; color: #e2e8f0; }
  #search-form input[type='submit'] { padding: 10px 14px; border-radius: 10px; border: none; background: #22c55e; color: #0b1220; font-weight: 700; cursor: pointer; }
  /* Modal styling */
  #buy-modal {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 1000;
  }
  #buy-modal.active { display: block; }
  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
  }
  .modal-card {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 360px;
    background: linear-gradient(120deg, rgba(103,232,249,0.12), rgba(165,180,252,0.08)), rgba(17, 24, 39, 0.95);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 20px 22px;
    box-shadow: 0 24px 70px rgba(0,0,0,0.3);
    color: #e5e7eb;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }
  .modal-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    color: #9ca3af;
  }
  .modal-title {
    font-size: 22px;
    font-weight: 700;
    color: #fff;
  }
  .modal-price {
    color: #a5b4fc;
    font-weight: 600;
    margin-top: 2px;
  }
  .modal-close {
    background: transparent;
    border: none;
    color: #e5e7eb;
    font-size: 24px;
    cursor: pointer;
  }
  .modal-form .field {
    margin: 16px 0;
  }
  .modal-form label {
    display: block;
    margin-bottom: 6px;
    color: #cbd5e1;
    font-weight: 600;
    font-size: 13px;
  }
  .modal-form input {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(15, 23, 42, 0.6);
    color: #fff;
    outline: none;
  }
  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 6px;
  }
  .primary-btn, .ghost-btn {
    border: none;
    border-radius: 10px;
    padding: 10px 14px;
    font-weight: 700;
    cursor: pointer;
  }
  .primary-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
  }
  .ghost-btn {
    background: rgba(255,255,255,0.1);
    color: #e5e7eb;
    border: 1px solid rgba(255,255,255,0.15);
  }
  .modal-error {
    margin-top: 10px;
    color: #fca5a5;
    font-size: 13px;
  }
</style>

<div id="message"></div>

<form id="search-form">
  <%= label_tag :search, "Search" %>
  <%= text_field_tag :search, params[:search], placeholder: "Search stocks..." %>
  <%= submit_tag "Search" %>
</form>

<div class="stock-list">
  <table>
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Name</th>
        <th>Real-time Price & 24h Change</th>
        <th>Available</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @stocks.each do |stock| %>
        <% updated_minutes_ago = ((Time.now - stock.updated_at) / 60).round %>
        <% is_fresh = updated_minutes_ago < 10 %>
        
        <tr class="stock-row" data-symbol="<%= stock.symbol %>">
          <td>
            <%= link_to stock.symbol, stock_path(stock), id: "stock-link-#{stock.symbol}" %>
            <% if is_fresh %>
              <span style="display: inline-block; margin-left: 8px; background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: bold; vertical-align: middle; animation: pulse 2s infinite;">
                <span style="display: inline-block; width: 6px; height: 6px; background: white; border-radius: 50%; margin-right: 3px; animation: blink 1s infinite;"></span>
                LIVE
              </span>
            <% end %>
          </td>
          <td><%= stock.name %></td>
          <td>
            <div style="font-size: 1.1em; font-weight: bold;">
              $<%= number_with_precision(stock.price, precision: 2) %>
            </div>
            <% price_change = stock.price_change %>
            <% if price_change %>
              <div style="margin-top: 5px;">
                <span class="price-change <%= price_change[:direction] == 'positive' ? 'positive text-success' : 'negative text-danger' %>" style="background: <%= price_change[:direction] == 'positive' ? '#d4edda' : '#f8d7da' %>; color: <%= price_change[:direction] == 'positive' ? '#155724' : '#721c24' %>; padding: 3px 8px; border-radius: 3px; font-size: 0.9em; font-weight: 500;">
                  <%= price_change[:direction] == 'positive' ? 'â–²' : 'â–¼' %>
                  <%= price_change[:direction] == 'positive' ? '+' : '-' %>$<%= number_with_precision(price_change[:amount].abs, precision: 2) %> 
                  (<%= price_change[:direction] == 'positive' ? '+' : '' %><%= price_change[:percentage] %>%)
                </span>
              </div>
            <% else %>
              <div style="margin-top: 5px;">
                <span style="background: #e9ecef; color: #495057; padding: 3px 8px; border-radius: 3px; font-size: 0.9em; font-weight: 500;">
                  â€” Change N/A
                </span>
              </div>
            <% end %>
            <div style="margin-top: 5px; font-size: 0.8em; color: #6c757d;">
              Last Updated: <%= updated_minutes_ago %> min ago
            </div>
          </td>
          <td><%= stock.available_quantity %></td>
          <td>
            <button class="buy-btn" data-stock-id="<%= stock.id %>" data-stock-symbol="<%= stock.symbol %>" data-stock-price="<%= stock.price %>">Buy</button>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- Buy Modal -->
<div id="buy-modal" style="display: none;">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-label">Buy Stock</div>
        <div class="modal-title"><span id="buy-symbol"></span></div>
        <div class="modal-price">$<span id="buy-price"></span></div>
      </div>
      <button type="button" class="modal-close" id="buy-cancel-btn">&times;</button>
    </div>
    <%= form_with url: "#", id: "buy-form", local: false, html: { class: "modal-form" } do |f| %>
      <div class="field">
        <%= f.label :quantity, "Quantity" %>
        <%= f.number_field :quantity, id: "buy-quantity", min: 1, required: true, placeholder: "Enter quantity" %>
      </div>
      <div class="modal-actions">
        <button type="button" class="ghost-btn" id="buy-cancel-btn-2">Cancel</button>
        <%= f.submit "Confirm", id: "buy-confirm-btn", class: "primary-btn" %>
      </div>
      <div id="buy-error" class="modal-error"></div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Show persisted transaction message (from buy/sell)
    (function() {
      let persistedMessage = sessionStorage.getItem('transactionMessage');
      if (!persistedMessage) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'transactionMessage') {
            persistedMessage = decodeURIComponent(value);
            break;
          }
        }
      }
      if (persistedMessage) {
        const messageEl = document.getElementById('message');
        if (messageEl) {
          messageEl.textContent = persistedMessage;
          messageEl.style.display = 'block';
        }
      }
    })();

    // Check for persisted message from previous transaction (sessionStorage or cookie)
    let persistedMessage = sessionStorage.getItem('transactionMessage');
    if (!persistedMessage) {
      // Try reading from cookie
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'transactionMessage') {
          persistedMessage = decodeURIComponent(value);
          break;
        }
      }
    }
    if (persistedMessage) {
      const messageEl = document.getElementById('message');
      if (messageEl) {
        messageEl.textContent = persistedMessage;
        messageEl.style.display = 'block';
        // Don't clear immediately - let test verify it first
      }
    }
    
    const buyButtons = document.querySelectorAll('.buy-btn');
    const buyModal = document.getElementById('buy-modal');
    const buyForm = document.getElementById('buy-form');
    const buyCancelBtn = document.getElementById('buy-cancel-btn');
    const buyCancelBtn2 = document.getElementById('buy-cancel-btn-2');
    const buySymbol = document.getElementById('buy-symbol');
    const buyPrice = document.getElementById('buy-price');
    const buyQuantity = document.getElementById('buy-quantity');
    const buyError = document.getElementById('buy-error');
    const buyConfirmBtn = document.getElementById('buy-confirm-btn');
    // Use window.currentStockId to make it accessible for testing
    window.currentStockId = null;

    buyButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        window.currentStockId = this.dataset.stockId;
        buySymbol.textContent = this.dataset.stockSymbol;
        buyPrice.textContent = parseFloat(this.dataset.stockPrice).toFixed(2);
        // Inline display: none on the modal was preventing visibility in tests; set display explicitly.
        buyModal.style.display = 'block';
        buyModal.classList.add('active');
        buyError.textContent = '';
        buyQuantity.value = '';
      });
    });

    buyCancelBtn.addEventListener('click', function() {
      buyModal.classList.remove('active');
      buyModal.style.display = 'none';
      window.currentStockId = null;
    });
    buyCancelBtn2.addEventListener('click', function() {
      buyModal.classList.remove('active');
      buyModal.style.display = 'none';
      window.currentStockId = null;
    });

    buyForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const quantity = buyQuantity.value;
      
      if (!quantity || quantity <= 0) {
        buyError.textContent = 'Please enter a valid quantity';
        return;
      }

      // Disable buttons during transaction
      buyConfirmBtn.disabled = true;
      buyCancelBtn.disabled = true;

      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ||
                       document.querySelector('input[name="authenticity_token"]')?.value;
      
      if (!window.currentStockId) {
        buyError.textContent = 'Error: Stock ID not set';
        buyConfirmBtn.disabled = false;
        buyCancelBtn.disabled = false;
        return;
      }
      
      console.log('Making buy request for stock ID:', window.currentStockId, 'quantity:', quantity);
      fetch(`/stocks/${window.currentStockId}/buy`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ quantity: quantity })
      })
      .then(response => {
        console.log('Buy response status:', response.status);
        if (!response.ok) {
          return response.json().then(data => {
            console.error('Buy error:', data.error);
            throw new Error(data.error || 'Transaction failed');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('Buy success:', data);
        // Store message in both sessionStorage and cookie before reload so it persists
        if (data.message) {
          sessionStorage.setItem('transactionMessage', data.message);
          // Also set a cookie that persists across page navigations
          document.cookie = 'transactionMessage=' + encodeURIComponent(data.message) + '; path=/';
        }
        document.getElementById('message').textContent = data.message;
        document.getElementById('balance').innerHTML = '<strong>Balance: $' + parseFloat(data.balance).toFixed(2) + '</strong>';
        buyModal.classList.remove('active');
        buyModal.style.display = 'none';
        buyConfirmBtn.disabled = false;
        buyCancelBtn.disabled = false;
        <% unless Rails.env.test? %>
        location.reload(); // Refresh to show updated data (skip reload in test to avoid stale elements)
        <% end %>
      })
      .catch(error => {
        console.error('Buy catch error:', error);
        buyError.textContent = error.message || 'Transaction failed. Please try again.';
        buyConfirmBtn.disabled = false;
        buyCancelBtn.disabled = false;
      });
    });

    // Search form submission
    document.getElementById('search-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const searchValue = document.querySelector('#search').value;
      window.location.href = '<%= stocks_path %>?search=' + encodeURIComponent(searchValue);
    });
  });
</script>
