<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; margin: -20px -20px 20px -20px; color: white;">
  <h1 style="margin: 0 0 10px 0; color: white;">ðŸ“Š Real-time Stock Market</h1>
  <p style="margin: 0; opacity: 0.9;">Check real-time prices, historical data, and make informed trading decisions</p>
</div>

<% if current_user %>
  <div id="balance" style="background: #28a745; color: white; padding: 15px; margin: 20px 0; border-radius: 5px;">
    <strong>ðŸ’° Your Balance: $<%= number_with_precision(current_user.balance, precision: 2) %></strong>
  </div>
<% end %>

<% if flash[:notice] %>
  <div class="notice"><%= flash[:notice] %></div>
<% end %>

<% if flash[:alert] %>
  <div class="alert"><%= flash[:alert] %></div>
<% end %>

<div id="message"></div>

<form id="search-form">
  <%= label_tag :search, "Search" %>
  <%= text_field_tag :search, params[:search], placeholder: "Search stocks..." %>
  <%= submit_tag "Search" %>
</form>

<div class="stock-list">
  <table>
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Name</th>
        <th>Real-time Price & 24h Change</th>
        <th>Available</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @stocks.each do |stock| %>
        <% updated_minutes_ago = ((Time.now - stock.updated_at) / 60).round %>
        <% is_fresh = updated_minutes_ago < 10 %>
        
        <tr class="stock-row" data-symbol="<%= stock.symbol %>">
          <td>
            <%= link_to stock.symbol, stock_path(stock), id: "stock-link-#{stock.symbol}" %>
            <% if is_fresh %>
              <span style="display: inline-block; margin-left: 8px; background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: bold; vertical-align: middle; animation: pulse 2s infinite;">
                <span style="display: inline-block; width: 6px; height: 6px; background: white; border-radius: 50%; margin-right: 3px; animation: blink 1s infinite;"></span>
                LIVE
              </span>
            <% end %>
          </td>
          <td><%= stock.name %></td>
          <td>
            <div style="font-size: 1.1em; font-weight: bold;">
              $<%= number_with_precision(stock.price, precision: 2) %>
            </div>
            <% price_change = stock.price_change %>
            <% if price_change %>
              <div style="margin-top: 5px;">
                <span class="price-change <%= price_change[:direction] == 'positive' ? 'positive text-success' : 'negative text-danger' %>" style="background: <%= price_change[:direction] == 'positive' ? '#d4edda' : '#f8d7da' %>; color: <%= price_change[:direction] == 'positive' ? '#155724' : '#721c24' %>; padding: 3px 8px; border-radius: 3px; font-size: 0.9em; font-weight: 500;">
                  <%= price_change[:direction] == 'positive' ? 'â–²' : 'â–¼' %>
                  <%= price_change[:direction] == 'positive' ? '+' : '-' %>$<%= number_with_precision(price_change[:amount].abs, precision: 2) %> 
                  (<%= price_change[:direction] == 'positive' ? '+' : '' %><%= price_change[:percentage] %>%)
                </span>
              </div>
            <% end %>
            <div style="margin-top: 5px; font-size: 0.8em; color: #6c757d;">
              Last Updated: <%= updated_minutes_ago %> min ago
            </div>
          </td>
          <td><%= stock.available_quantity %></td>
          <td>
            <button class="buy-btn" data-stock-id="<%= stock.id %>" data-stock-symbol="<%= stock.symbol %>" data-stock-price="<%= stock.price %>">Buy</button>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- Buy Modal -->
<div id="buy-modal" style="display: none;">
  <div class="modal-content">
    <h2>Buy Stock</h2>
    <p>Symbol: <span id="buy-symbol"></span></p>
    <p>Price: $<span id="buy-price"></span></p>
    <%= form_with url: "#", id: "buy-form", local: false do |f| %>
      <%= f.label :quantity, "Quantity" %>
      <%= f.number_field :quantity, id: "buy-quantity", min: 1, required: true %>
      <%= f.submit "Confirm", id: "buy-confirm-btn" %>
      <button type="button" id="buy-cancel-btn">Cancel</button>
    <% end %>
    <div id="buy-error"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Show persisted transaction message (from buy/sell)
    (function() {
      let persistedMessage = sessionStorage.getItem('transactionMessage');
      if (!persistedMessage) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'transactionMessage') {
            persistedMessage = decodeURIComponent(value);
            break;
          }
        }
      }
      if (persistedMessage) {
        const messageEl = document.getElementById('message');
        if (messageEl) {
          messageEl.textContent = persistedMessage;
          messageEl.style.display = 'block';
        }
      }
    })();

    // Check for persisted message from previous transaction (sessionStorage or cookie)
    let persistedMessage = sessionStorage.getItem('transactionMessage');
    if (!persistedMessage) {
      // Try reading from cookie
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'transactionMessage') {
          persistedMessage = decodeURIComponent(value);
          break;
        }
      }
    }
    if (persistedMessage) {
      const messageEl = document.getElementById('message');
      if (messageEl) {
        messageEl.textContent = persistedMessage;
        messageEl.style.display = 'block';
        // Don't clear immediately - let test verify it first
      }
    }
    
    const buyButtons = document.querySelectorAll('.buy-btn');
    const buyModal = document.getElementById('buy-modal');
    const buyForm = document.getElementById('buy-form');
    const buyCancelBtn = document.getElementById('buy-cancel-btn');
    const buySymbol = document.getElementById('buy-symbol');
    const buyPrice = document.getElementById('buy-price');
    const buyQuantity = document.getElementById('buy-quantity');
    const buyError = document.getElementById('buy-error');
    const buyConfirmBtn = document.getElementById('buy-confirm-btn');
    // Use window.currentStockId to make it accessible for testing
    window.currentStockId = null;

    buyButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        window.currentStockId = this.dataset.stockId;
        buySymbol.textContent = this.dataset.stockSymbol;
        buyPrice.textContent = parseFloat(this.dataset.stockPrice).toFixed(2);
        buyModal.style.display = 'block';
        buyError.textContent = '';
        buyQuantity.value = '';
      });
    });

    buyCancelBtn.addEventListener('click', function() {
      buyModal.style.display = 'none';
      window.currentStockId = null;
    });

    buyForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const quantity = buyQuantity.value;
      
      if (!quantity || quantity <= 0) {
        buyError.textContent = 'Please enter a valid quantity';
        return;
      }

      // Disable buttons during transaction
      buyConfirmBtn.disabled = true;
      buyCancelBtn.disabled = true;

      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ||
                       document.querySelector('input[name="authenticity_token"]')?.value;
      
      if (!window.currentStockId) {
        buyError.textContent = 'Error: Stock ID not set';
        buyConfirmBtn.disabled = false;
        buyCancelBtn.disabled = false;
        return;
      }
      
      console.log('Making buy request for stock ID:', window.currentStockId, 'quantity:', quantity);
      fetch(`/stocks/${window.currentStockId}/buy`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ quantity: quantity })
      })
      .then(response => {
        console.log('Buy response status:', response.status);
        if (!response.ok) {
          return response.json().then(data => {
            console.error('Buy error:', data.error);
            throw new Error(data.error || 'Transaction failed');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('Buy success:', data);
        // Store message in both sessionStorage and cookie before reload so it persists
        if (data.message) {
          sessionStorage.setItem('transactionMessage', data.message);
          // Also set a cookie that persists across page navigations
          document.cookie = 'transactionMessage=' + encodeURIComponent(data.message) + '; path=/';
        }
        document.getElementById('message').textContent = data.message;
        document.getElementById('balance').innerHTML = '<strong>Balance: $' + parseFloat(data.balance).toFixed(2) + '</strong>';
        buyModal.style.display = 'none';
        <% unless Rails.env.test? %>
        location.reload(); // Refresh to show updated data (skip reload in test to avoid stale elements)
        <% end %>
      })
      .catch(error => {
        console.error('Buy catch error:', error);
        buyError.textContent = error.message || 'Transaction failed. Please try again.';
        buyConfirmBtn.disabled = false;
        buyCancelBtn.disabled = false;
      });
    });

    // Search form submission
    document.getElementById('search-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const searchValue = document.querySelector('#search').value;
      window.location.href = '<%= stocks_path %>?search=' + encodeURIComponent(searchValue);
    });
  });
</script>
