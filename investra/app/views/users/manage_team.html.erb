<h1>Manage Team</h1>

<% if flash[:notice] %>
  <div class="notice"><%= flash[:notice] %></div>
<% end %>

<% if flash[:alert] %>
  <div class="alert"><%= flash[:alert] %></div>
<% end %>

<h2>My Associates</h2>
<% if @associates.any? %>
  <ul>
    <% @associates.each do |associate| %>
      <li>
        <strong><%= associate.email %></strong>
        <% if @confirm_remove_user&.id == associate.id %>
          <%= form_with url: remove_associate_user_path(associate), method: :delete, local: true do |f| %>
            <%= f.submit "Confirm" %>
          <% end %>
        <% else %>
          <%= form_with url: manage_team_path, method: :get, local: true do %>
            <%= hidden_field_tag :confirm_remove_id, associate.id %>
            <%= hidden_field_tag :show_traders, 'true' if @show_traders %>
            <%= hidden_field_tag :search, @search_term if @search_term.present? %>
            <%= submit_tag "Remove" %>
          <% end %>
        <% end %>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>No associates yet.</p>
<% end %>

<h2>Available Traders</h2>
<% link_params = { show_traders: 'true' } %>
<% link_params[:search] = @search_term if @search_term.present? %>
<%= link_to "Add Associate", manage_team_path(link_params), id: "add_associate_link" %>

<% if @show_traders %>
  <div id="trader_list">
    <%= form_with url: manage_team_path, method: :get, local: true, id: "search_form" do %>
      <%= hidden_field_tag :show_traders, 'true' %>
      <% if @selected_trader %>
        <%= hidden_field_tag :selected_user_id, @selected_trader.id %>
      <% end %>
      <%= text_field_tag :search, @search_term, id: "search", placeholder: "Search by name..." %>
      <%= submit_tag "Filter" %>
    <% end %>

    <% base_link_params = { show_traders: 'true' } %>
    <% base_link_params[:search] = @search_term if @search_term.present? %>

    <ul id="trader_items">
      <% @available_traders.each do |trader| %>
        <% trader_params = base_link_params.merge(selected_user_id: trader.id) %>
        <li class="trader-item" data-name="<%= "#{trader.first_name} #{trader.last_name}" %>">
          <%= link_to trader.email, manage_team_path(trader_params), id: trader.email %>
          <% if @selected_trader&.id == trader.id %>
            <span>(selected)</span>
          <% end %>
        </li>
      <% end %>
    </ul>

    <% if @available_traders.none? %>
      <p>No traders available.</p>
    <% end %>

    <% if @selected_trader %>
      <%= form_with url: assign_as_associate_user_path(@selected_trader), method: :post, local: true do |f| %>
        <%= f.submit "Assign as Associate" %>
      <% end %>
    <% end %>
  </div>
<% end %>

<script>
  function attachSearchAutoSubmit() {
    var searchField = document.getElementById('search');
    if (searchField && searchField.form && !searchField.dataset.autoSubmitBound) {
      searchField.addEventListener('input', function () {
        if (this.form.requestSubmit) {
          this.form.requestSubmit();
        } else {
          this.form.submit();
        }
      });
      searchField.dataset.autoSubmitBound = 'true';
    }
  }

  document.addEventListener('DOMContentLoaded', attachSearchAutoSubmit);
  document.addEventListener('turbo:load', attachSearchAutoSubmit);
</script>

