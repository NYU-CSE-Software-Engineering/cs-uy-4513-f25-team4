<div class="analytics-shell">
  <div class="analytics-hero">
    <div>
      <div class="eyebrow">Analytics</div>
      <h1>Portfolio Trend</h1>
      <p>Visualize price history and run quick what-if checks.</p>
    </div>
    <div>
      <%= link_to "What-If Simulator", simulate_analytics_index_path, class: "pill-btn pill-btn--secondary" %>
    </div>
  </div>

  <% if MarketData::YahooClient::USE_MOCK_DATA %>
    <div class="alert alert--info" style="margin-bottom: 1rem;">
      <strong>⚠️ Mock Data Mode:</strong> Using simulated data for development. Set USE_MOCK_DATA=false to use real Yahoo Finance API.
    </div>
  <% end %>

  <div class="analytics-grid">
    <div class="card">
      <h3>Look up a ticker</h3>
      <%= form_with url: analytics_index_path, method: :get, local: true, class: "stock-search-form" do |f| %>
        <div class="form-group">
          <%= f.label :ticker, "Stock Symbol", class: "form-label" %>
          <%= f.text_field :ticker,
              value: @ticker,
              placeholder: "e.g., AAPL, TSLA, MSFT",
              class: "form-control",
              required: true,
              autofocus: true %>
        </div>

        <div class="form-group">
          <%= f.label :range, "Date Range", class: "form-label" %>
          <%= f.select :range,
              options_for_select([
                ["1 Week", "5d"],
                ["1 Month", "1mo"],
                ["3 Months", "3mo"],
                ["6 Months", "6mo"],
                ["1 Year", "1y"],
                ["2 Years", "2y"],
                ["5 Years", "5y"],
                ["All Time", "max"]
              ], @range),
              {},
              { class: "form-control" } %>
        </div>

        <%= f.submit "View Chart", class: "pill-btn pill-btn--primary" %>
      <% end %>
    </div>

    <div class="card chart-card">
      <% if @chart_data %>
        <div class="chart-header">
          <div>
            <div class="eyebrow">Ticker</div>
            <h2><%= @chart_data[:ticker] %></h2>
          </div>
          <div class="chart-meta">
            <span class="pill">Range: <%= @range %></span>
            <span class="pill">Points: <%= @chart_data[:prices]&.length || 0 %></span>
          </div>
        </div>
        <canvas id="stockChart" width="400" height="200"></canvas>
      <% elsif @ticker.present? && !@error %>
        <p class="muted">Enter a stock symbol above to view its price trend chart.</p>
      <% else %>
        <p class="muted">Search a ticker to see its price history.</p>
      <% end %>
    </div>
  </div>

  <% if @error %>
    <div class="alert alert--error" style="margin-top:1rem;">
      <strong>Error:</strong> <%= @error %>
      <% if @error.include?("Rate limit") || @error.include?("429") %>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">
          <strong>Tip:</strong> Yahoo Finance API has rate limits. Please wait a few minutes before trying again.
          Historical data is cached for 2 hours, so repeated requests for the same stock and date range won't trigger new API calls.
        </p>
      <% end %>
    </div>
  <% end %>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  <% if @chart_data && @chart_data[:timestamps] && @chart_data[:prices] %>
    (function() {
      const ctx = document.getElementById('stockChart');
      if (!ctx) return;

      const timestamps = <%= raw @chart_data[:timestamps].to_json %>;
      const prices = <%= raw @chart_data[:prices].to_json %>;
      const ticker = '<%= @chart_data[:ticker] %>';

      // Convert timestamps to dates
      const labels = timestamps.map(ts => {
        const date = new Date(ts * 1000);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      });

      // Filter out null/undefined prices
      const validData = prices.map((price, index) => ({
        x: labels[index],
        y: price
      })).filter(item => item.y != null && !isNaN(item.y));

      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: validData.map(item => item.x),
          datasets: [{
            label: `${ticker} Stock Price`,
            data: validData.map(item => item.y),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderWidth: 2,
            fill: true,
            tension: 0.1,
            pointRadius: 2,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            title: {
              display: true,
              text: `${ticker} Price Over Time`,
              font: {
                size: 18
              }
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return `$${context.parsed.y.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: 'Price (USD)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(2);
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Date'
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    })();
  <% end %>
</script>
