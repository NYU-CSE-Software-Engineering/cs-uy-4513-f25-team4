<% content_for :title, "My Portfolio" %>

<div class="page">
  <div class="page__header">
    <div class="eyebrow">Portfolio</div>
    <h1>Holdings Snapshot</h1>
    <p class="lede">A lightweight view of your positions, market values, and available cash.</p>
  </div>

  <div class="grid">
    <div class="card card--stat">
      <div class="label">Total Value</div>
      <div class="value"><%= number_to_currency(@summary[:total_value]) %></div>
    </div>
    <div class="card card--stat">
      <div class="label">Cash Balance</div>
      <div class="value"><%= number_to_currency(@summary[:cash_balance]) %></div>
    </div>
    <div class="card card--stat">
      <div class="label">Positions</div>
      <div class="value"><%= @summary[:holdings].size %></div>
    </div>
  </div>

  <div class="card">
    <div class="card__header">
      <div>
        <div class="label">Holdings</div>
        <h2>Positions & P/L</h2>
      </div>
    </div>
    <div id="message"></div>
    <div class="portfolio-list">
      <div class="table">
        <div class="table__head">
          <div>Symbol</div>
          <div>Qty</div>
          <div>Cost Basis</div>
          <div>Market</div>
          <div>Value</div>
          <div>P/L</div>
          <div>Actions</div>
        </div>
        <div class="table__body">
          <% @summary[:holdings].each do |holding| %>
            <% gain_loss = holding[:gain_loss].to_f %>
            <div class="table__row stock-row" data-symbol="<%= holding[:symbol] %>">
              <div class="mono"><%= holding[:symbol] %></div>
              <div><%= holding[:quantity] %></div>
              <div><%= number_to_currency(holding[:cost_basis]) %></div>
              <div><%= number_to_currency(holding[:market_price]) %></div>
              <div><%= number_to_currency(holding[:market_value]) %></div>
              <div class="<%= gain_loss >= 0 ? 'pill pill--gain' : 'pill pill--loss' %>">
                <%= gain_loss >= 0 ? "+" : "" %><%= number_to_currency(gain_loss) %>
              </div>
              <div>
                <button class="sell-btn button button--ghost" data-stock-id="<%= holding[:stock_id] %>" data-stock-symbol="<%= holding[:symbol] %>" data-stock-price="<%= holding[:market_price] %>" data-max-quantity="<%= holding[:quantity] %>">
                  Sell
                </button>
              </div>
            </div>
          <% end %>
          <% if @summary[:holdings].empty? %>
            <div class="table__empty">No holdings yet.</div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sell Modal (keeps compatibility with Cucumber steps) -->
<div id="sell-modal" style="display: none;">
  <div class="modal-content">
    <h2>Sell Stock</h2>
    <p>Symbol: <span id="sell-symbol"></span></p>
    <p>Price: $<span id="sell-price"></span></p>
    <p>Max Quantity: <span id="sell-max-quantity"></span></p>
    <%= form_with url: "#", id: "sell-form", local: false do |f| %>
      <%= f.label :quantity, "Quantity" %>
      <%= f.number_field :quantity, id: "sell-quantity", min: 1, required: true %>
      <%= f.submit "Confirm", id: "sell-confirm-btn" %>
      <button type="button" id: "sell-cancel-btn">Cancel</button>
    <% end %>
    <div id="sell-error"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Show persisted transaction message (from buy/sell)
    (function() {
      let persistedMessage = sessionStorage.getItem('transactionMessage');
      if (!persistedMessage) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'transactionMessage') {
            persistedMessage = decodeURIComponent(value);
            break;
          }
        }
      }
      if (persistedMessage) {
        const messageEl = document.getElementById('message');
        if (messageEl) {
          messageEl.textContent = persistedMessage;
          messageEl.style.display = 'block';
        }
      }
    })();

    const sellButtons = document.querySelectorAll('.sell-btn');
    const sellModal = document.getElementById('sell-modal');
    const sellForm = document.getElementById('sell-form');
    const sellCancelBtn = document.getElementById('sell-cancel-btn');
    const sellSymbol = document.getElementById('sell-symbol');
    const sellPrice = document.getElementById('sell-price');
    const sellMaxQuantity = document.getElementById('sell-max-quantity');
    const sellQuantity = document.getElementById('sell-quantity');
    const sellError = document.getElementById('sell-error');
    const sellConfirmBtn = document.getElementById('sell-confirm-btn');
    window.currentStockId = window.currentStockId || null;

    sellButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        window.currentStockId = this.dataset.stockId;
        sellSymbol.textContent = this.dataset.stockSymbol;
        sellPrice.textContent = parseFloat(this.dataset.stockPrice).toFixed(2);
        sellMaxQuantity.textContent = this.dataset.maxQuantity;
        sellQuantity.max = this.dataset.maxQuantity;
        sellModal.style.display = 'block';
        sellError.textContent = '';
        sellQuantity.value = '';
      });
    });

    sellCancelBtn.addEventListener('click', function() {
      sellModal.style.display = 'none';
      window.currentStockId = null;
    });

    sellForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const quantity = sellQuantity.value;

      if (!quantity || quantity <= 0) {
        sellError.textContent = 'Please enter a valid quantity';
        return;
      }

      if (parseInt(quantity) > parseInt(sellMaxQuantity.textContent)) {
        sellError.textContent = 'Insufficient shares';
        return;
      }

      sellConfirmBtn.disabled = true;
      sellCancelBtn.disabled = true;

      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ||
                       document.querySelector('input[name="authenticity_token"]')?.value;
      fetch(`/stocks/${window.currentStockId}/sell`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ quantity: quantity })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'Transaction failed');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.message) {
          sessionStorage.setItem('transactionMessage', data.message);
          document.cookie = 'transactionMessage=' + encodeURIComponent(data.message) + '; path=/';
        }
        document.getElementById('message').textContent = data.message;
        sellModal.style.display = 'none';
        location.reload();
      })
      .catch(error => {
        sellError.textContent = error.message || 'Transaction failed. Please try again.';
        sellConfirmBtn.disabled = false;
        sellCancelBtn.disabled = false;
      });
    });
  });
</script>
