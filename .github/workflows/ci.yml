name: CI

on:
  push:
    branches: [ main, hanqiLiuBranch ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: investra_test
          MYSQL_USER: investra
          MYSQL_PASSWORD: investra
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      RAILS_ENV: test
      DB_HOST: 127.0.0.1
      DATABASE_URL: mysql2://investra:investra@127.0.0.1/investra_test

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.2
          bundler-cache: true
          working-directory: investra

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential libmariadb-dev nodejs yarn
          # Install Google Chrome and ChromeDriver for Capybara JavaScript tests
          sudo apt-get install -y wget unzip curl
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update -y
          sudo apt-get install -y google-chrome-stable
          # Install ChromeDriver using Chrome for Testing (latest stable)
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" | grep -oE '"version":"[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+"' | head -1 | cut -d'"' -f4)
          wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip" -O /tmp/chromedriver.zip
          sudo unzip -q /tmp/chromedriver.zip -d /tmp/
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver
          # Cleanup: use sudo since files were created with sudo, and || true to make non-fatal
          sudo rm -rf /tmp/chromedriver* || true
          rm -f /tmp/chromedriver.zip || true

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL to start..."
          for i in {1..30}; do
            # Try root first (health check), then investra user
            if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent 2>/dev/null; then
              # Wait a bit more for user creation
              sleep 2
              if mysqladmin ping -h 127.0.0.1 -uinvestra -pinvestra --silent 2>/dev/null; then
                echo "✅ MySQL is ready!"
                break
              fi
            fi
            echo "⏳ Waiting ($i)..."
            sleep 2
          done

      - name: Prepare database
        working-directory: investra
        run: |
          bundle exec rails db:drop db:create db:schema:load

      - name: Run RSpec tests
        working-directory: investra
        run: bundle exec rspec --format documentation

      - name: Run Cucumber tests for assign_as_admin feature
        working-directory: investra
        run: bundle exec cucumber features/assign_as_admin.feature --format pretty

      - name: Run Cucumber tests for assign_associates feature
        working-directory: investra
        run: bundle exec cucumber features/assign_associates.feature --format pretty

      - name: Run Cucumber tests for user registration feature
        working-directory: investra
        run: bundle exec cucumber features/user_registration.feature --format pretty

      - name: Run Cucumber tests for company_management feature
        working-directory: investra
        run: bundle exec cucumber features/company_management.feature --format pretty

      - name: Run Cucumber tests for buying_and_selling feature
        working-directory: investra
        run: bundle exec cucumber features/buying_and_selling.feature --format pretty